function WebPush(){this.webSocket;this.url;this.requestDisconnect;this.id;this.onConnected;this.onDisconnected;this.onMessageReceived;}WebPush.prototype.onConnected=function(){};WebPush.prototype.onDisconnected=function(){};WebPush.prototype.onMessageReceived=function(msg){};WebPush.prototype.connect=function(url,forceLongPolling){var webPush=this;this.url=url;this.requestDisconnect=false;this.connected=false;$.support.cors=true;$(window).unload(function(){log('trinh duyet chuyen trang, close ');webPush.close();});$(window).on('beforeunload',function(){log("before unload");webPush.close();});if(window.WebSocket&&(forceLongPolling===undefined||!forceLongPolling)){log('use websocket');this.webSocket=new WebSocket('wss://'+url+'/websocket');this.webSocket.onopen=this.onConnected;this.webSocket.onclose=this.onDisconnected;this.webSocket.onerror=function(evt){webPush.onDisconnected();};this.webSocket.onmessage=function(evt){var msg=JSON.parse(evt.data);webPush.onMessageReceived(msg);};this.onMessageReceived;}else{log('use long polling');$.ajax({dataType:'json',url:'http://'+url+'/connect',data:{},cache:false,success:function(data,textStatus,jqXHR){if(data.r===1){webPush.id=data.id;webPush.onConnected();webPush.poll(url);webPush.connected=true;}else{webPush.connected=false;webPush.onDisconnected();}},error:function(jqXHR,textStatus,errorThrown){webPush.connected=false;webPush.onDisconnected();}});}};WebPush.prototype.poll=function(url){var webPush=this;$.ajax({dataType:'json',url:'http://'+url+'/poll/'+webPush.id,cache:false,data:{},success:function(data,textStatus,jqXHR){if(data.r===1){if(data.list){for(var i=0;i<data.list.length;i++){var msg_i=data.list[i];webPush.onMessageReceived(msg_i);}}if(!webPush.requestDisconnect){setTimeout(function(){webPush.poll(url);},1);}else{webPush.connected=false;webPush.onDisconnected();}}else{webPush.connected=false;webPush.onDisconnected();}},error:function(jqXHR,textStatus,errorThrown){webPush.connected=false;webPush.onDisconnected();},complete:function(jqXHR,textStatus){if(textStatus==='success'){}}});};WebPush.prototype.send=function(msg){var webPush=this;if(this.webSocket){this.webSocket.send(JSON.stringify(msg));}else{$.ajax({dataType:'json',url:'http://'+webPush.url+'/send/'+webPush.id,type:'POST',cache:false,data:JSON.stringify(msg),success:function(data,textStatus,jqXHR){},error:function(jqXHR,textStatus,errorThrown){log('error send: '+textStatus+"--"+errorThrown);}});}};WebPush.prototype.sendWait=function(msg,callback){var webPush=this;if(this.webSocket){this.waitForConnection(function(){webPush.webSocket.send(JSON.stringify(msg));if(typeof callback!=='undefined'){callback();}},1000);}else{this.waitForConnectionLongPolling(function(){$.ajax({dataType:'json',url:'http://'+webPush.url+'/send/'+webPush.id,type:'POST',cache:false,data:JSON.stringify(msg),success:function(data,textStatus,jqXHR){log('success send: '+data);},error:function(jqXHR,textStatus,errorThrown){log('error send: '+textStatus+"--"+errorThrown);}});if(typeof callback!=='undefined'){callback();}},1000);}};WebPush.prototype.waitForConnectionLongPolling=function(callback,interval){if(webPush.connected){callback();}else{var that=this;setTimeout(function(){that.waitForConnectionLongPolling(callback,interval);},interval);}}
WebPush.prototype.waitForConnection=function(callback,interval){if(this.webSocket.readyState===1){callback();}else{var that=this;setTimeout(function(){that.waitForConnection(callback,interval);},interval);}};WebPush.prototype.close=function(){var webPush=this;if(this.webSocket){this.webSocket.close();}else{this.requestDisconnect=true;log('chuyen nhe------------------');$.ajax({dataType:'json',url:'http://'+webPush.url+'/disconnect/'+webPush.id,type:'GET',cache:false,data:{},success:function(data,textStatus,jqXHR){},error:function(jqXHR,textStatus,errorThrown){}});}};